<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

    <mapper namespace="com.spring.dishcovery.mapper.ChatMapper">
        <resultMap id="ChatMap" type="com.spring.dishcovery.entity.ChatMessage">
            <id property="id" column="id"/>
            <result property="userId" column="user_id"/>
            <result property="role" column="role"/>
            <result property="content" column="content"/>
            <result property="createdAt" column="created_at"/>
        </resultMap>

        <insert id="insert" parameterType="com.spring.dishcovery.entity.ChatMessage" useGeneratedKeys="true"
                keyProperty="id">
            INSERT INTO chat_history (user_id, role, content, created_at)
            VALUES (#{userId}, #{role}, #{content}, NOW())
        </insert>

        <select id="findByUserId" resultMap="ChatMap" parameterType="String">
            SELECT ele.id,
                   ele.user_id,
                   ele.role,
                   ele.content,
                   ele.created_at
              FROM (SELECT id, user_id, role, content, created_at
                    FROM chat_history
                    WHERE user_id = #{userId}
                    ORDER BY created_at DESC LIMIT 2) ele
            ORDER BY created_at
        </select>
    </mapper>

